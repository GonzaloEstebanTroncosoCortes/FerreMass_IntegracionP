version: "3.9"

services:
  db_eps:
    image: postgres:10
    volumes:
      - /home/eps/data/db:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    restart: always
    networks:
      djangonetwork_eps:
        ipv4_address: 172.21.21.12

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin4_container
    restart: always
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      djangonetwork_eps:
        ipv4_address: 172.21.21.20


  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ATN_PROD: 'True'
        ATN_DB_ENGINE: 'django.db.backends.postgresql_psycopg2'
        ATN_DB: 'postgres'
        ATN_DB_USER: 'postgres'
        ATN_DB_PASSWD: 'postgres'
        ATN_DB_HOST: 'db_eps'
        ATN_DB_PORT: '5432'

    volumes:
      - static:/code/static
      - .:/code
    depends_on:
      - db_eps
    restart: always
    networks:
      djangonetwork_eps:
        ipv4_address: 172.21.21.11
    links:
      - db_eps:db_eps

  nginx:
    image: nginx:1.13
    build:
      context: .
      dockerfile: Dockerfile.nginx
    volumes:
      - ./config/nginx/conf.dev.d:/etc/nginx/conf.d
      - static:/code/static
    depends_on:
      - backend
    restart: always
    networks:
      djangonetwork_eps:
        ipv4_address: 172.21.21.10


networks:
      djangonetwork_eps:
          name: djangonetwork_eps
          driver: bridge
          ipam:
            config:
              - subnet: 172.21.21.0/24

volumes:
  .:
  static:
  pgadmin-data:
